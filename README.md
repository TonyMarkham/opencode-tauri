# OpenCode Tauri-Blazor Desktop Client

This is a cross-platform desktop client for OpenCode built with Tauri (Rust backend) and Blazor (.NET frontend).

## Project Structure

This feature follows the Cognexus project layout pattern:

```
clients/tauri-blazor/                        # Feature root (self-contained)
├── apps/
│   └── desktop/
│       └── opencode/                        # Tauri desktop application
│           ├── src/                         # Rust Tauri code (main.rs, commands, state)
│           ├── frontend/                    # Built Blazor output (wwwroot) - generated by dotnet publish
│           ├── icons/                       # Application icons
│           ├── Cargo.toml                   # Tauri app manifest
│           ├── build.rs                     # Tauri build script
│           └── tauri.conf.json              # Tauri configuration
├── backend/                                 # Shared Rust crates for this feature
│   └── client-core/                         # Server discovery and API client logic
│       ├── src/
│       │   ├── lib.rs                       # Public API exports
│       │   ├── discovery/
│       │   │   ├── mod.rs                   # Discovery module
│       │   │   ├── process.rs               # discover(), stop_pid(), check_health()
│       │   │   └── spawn.rs                 # spawn_and_wait()
│       │   ├── error/
│       │   │   ├── mod.rs                   # Error module
│       │   │   ├── discovery.rs             # DiscoveryError enum
│       │   │   └── spawn.rs                 # SpawnError enum
│       │   └── tests/                       # Unit tests (mirror src/ structure)
│       ├── integration_tests/               # Integration tests
│       │   ├── mod.rs
│       │   ├── discovery/
│       │   └── error/
│       └── Cargo.toml                       # client-core crate manifest
├── models/                                  # Shared models and utilities across crates
│   ├── src/
│   │   ├── lib.rs                           # Public API exports with layer docs
│   │   ├── server_info/                     # ServerInfo model module
│   │   │   ├── mod.rs                       # Module exports
│   │   │   ├── info.rs                      # ServerInfo struct (protobuf-generated)
│   │   │   └── builder.rs                   # ServerInfoBuilder with validation
│   │   ├── error/
│   │   │   ├── mod.rs                       # Error utilities module
│   │   │   ├── error_location.rs            # ErrorLocation struct
│   │   │   └── model_error.rs               # ModelError enum
│   │   └── tests/                           # Unit tests (mirror src/ structure)
│   │       ├── mod.rs
│   │       ├── error_location.rs            # Tests for error/error_location.rs
│   │       └── server_info/                 # Tests for server_info module
│   │           ├── mod.rs
│   │           └── builder.rs               # Tests for server_info/builder.rs
│   ├── build.rs                             # Protobuf code generation (prost-build)
│   └── Cargo.toml                           # models crate manifest
├── frontend/                                # Blazor source code
│   └── desktop/                             # Desktop-specific frontend projects
│       ├── opencode/                        # Blazor WebAssembly project (.NET 10)
│       │   ├── Pages/                       # Blazor pages/components
│       │   │   ├── Home.razor               # Main server management page
│       │   │   └── NotFound.razor           # 404 page
│       │   ├── Layout/                      # Layout components
│       │   │   ├── MainLayout.razor         # Main layout
│       │   │   └── NavMenu.razor            # Navigation menu
│       │   ├── Services/                    # C# services for Tauri interop
│       │   │   ├── IServerService.cs        # Service interface
│       │   │   ├── ServerService.cs         # Service implementation
│       │   │   ├── TauriCommands.cs         # Tauri command constants
│       │   │   ├── TauriConstants.cs        # Tauri interop constants
│       │   │   └── Exceptions/              # Custom exception hierarchy
│       │   │       └── ServerOperationException.cs
│       │   ├── wwwroot/                     # Static assets
│       │   │   ├── css/                     # CSS files
│       │   │   ├── index.html               # HTML entry point
│       │   │   └── favicon.png              # Favicon
│       │   ├── App.razor                    # Blazor app root
│       │   ├── Program.cs                   # Blazor app entry point
│       │   ├── _Imports.razor               # Global Blazor imports
│       │   └── Opencode.csproj              # Blazor project file
│       ├── Opencode.Tests/                  # C# unit tests (.NET 10)
│       │   ├── Services/
│       │   │   └── ServerServiceTests.cs    # Tests for ServerService
│       │   ├── _Imports.razor               # Test imports (bUnit)
│       │   └── Opencode.Tests.csproj        # Test project file
│       └── Desktop.sln                      # Solution file for desktop projects
├── proto/                                   # Protobuf definitions (single source of truth)
│   └── server.proto                         # ServerInfo message definition
├── Cargo.toml                               # Workspace root manifest
├── README.md                                # This file
└── TEST_COVERAGE.md                         # Test documentation
```

## Architecture

**Core Principle:** [Tauri is ONLY for webview hosting](./docs/adr/0002-thin-tauri-layer-principle.md). All application logic lives in `client-core`.

```
Blazor (C#) → [gRPC] → client-core (Rust) → [HTTP/SSE] → OpenCode Server
                            ↑
                     Tauri calls start()
```

### Layer Responsibilities

- **Tauri Layer** (`apps/desktop/opencode/src/`): Webview host + minimal glue code
  - Hosts Blazor webview
  - Calls `client_core::grpc::start_grpc_server()`
  - Provides OS-specific APIs (file dialogs, system tray)
  - **Does NOT contain business logic**

- **client-core** (`backend/client-core/`): Self-contained application engine
  - gRPC server implementation
  - OpenCode server HTTP client
  - Session/message/tool/agent management
  - All business logic (testable without Tauri)
  - Unit tests in `src/tests/` (mirror source structure)
  - Integration tests in `integration_tests/` (configured via `[[test]]` in Cargo.toml)

- **Models & Utilities** (`models/`): Shared models and utilities across all crates
  - ServerInfo model (protobuf-generated)
  - ErrorLocation trait for error tracking
  - Unit tests in `src/tests/`

- **Blazor Frontend** (`frontend/opencode/`): C# UI layer (compiled to `apps/desktop/opencode/frontend/`)
  - Razor components (Radzen UI library)
  - gRPC client services (thin wrappers)
  - Markdown rendering (Markdig)
  - **Does NOT directly call OpenCode server** (goes through gRPC → client-core)

## Development

### Building the Stack

#### 1. Build Blazor Frontend

First, publish the Blazor WebAssembly app in Release mode:

```bash
cd frontend/desktop
dotnet publish -c Release
```

This compiles the Blazor app and outputs the built files to `apps/desktop/opencode/frontend/wwwroot/`.

**Protobuf Auto-Generation (C#):** The `dotnet publish` command automatically generates C# classes from `proto/server.proto` via the `Grpc.Tools` package. The generated `ServerInfo` class is included in the build automatically - no separate step needed.

#### 2. Run Tauri Desktop App

From the repository root, run the Tauri development build:

```bash
cargo tauri dev
```

This will:
- Compile the Rust backend
- Start the Tauri desktop application
- Load the Blazor frontend from the built wwwroot directory
- Enable hot-reload for Rust code changes

**Protobuf Auto-Generation (Rust):** The `cargo tauri dev` command automatically triggers the `models/build.rs` script, which uses `prost-build` to generate Rust structs from `proto/server.proto`. This happens automatically before compiling any crate that depends on the `models` crate - no separate step needed.

**Note:** You must build the Blazor frontend (step 1) before running Tauri dev, as Tauri serves the static files from the built output.

## Testing

### Run All Tests

```bash
cd clients/tauri-blazor
cargo test --workspace
cd frontend/desktop && dotnet test Desktop.sln
```

### Run Rust Tests Only

```bash
cd clients/tauri-blazor
cargo test --workspace
```

### Run C# Tests Only

```bash
cd clients/tauri-blazor/frontend/desktop
dotnet test Desktop.sln
```

## References

### Architecture Decision Records (ADRs)

**Universal Constraints (READ FIRST):**
- [No Custom JavaScript Policy](./docs/adr/NO_CUSTOM_JAVASCRIPT_POLICY.md) - ZERO custom JavaScript (ABSOLUTE requirement)

**ADRs:**
- [ADR Index](./docs/adr/README.md) - All architectural decisions
- [ADR-0001: Tauri + Blazor Desktop Client](./docs/adr/0001-tauri-blazor-desktop-client.md) - Why Tauri+Blazor was chosen
- [ADR-0002: Thin Tauri Layer Principle](./docs/adr/0002-thin-tauri-layer-principle.md) - Separation of concerns

### Documentation

**Architecture:**
- [Architecture Guide](./docs/ARCHITECTURE.md) - Implementation guide (how to code, examples, anti-patterns)
- [ADR Index](./docs/adr/README.md) - Architecture Decision Records (why decisions were made)

**Implementation:**
- [Session Plan](./SESSION_PLAN.md) - Implementation sessions (1-6)
- [Protobuf Documentation](./docs/proto/README.md) - Data model schemas (72+ JSON schemas)

### External References

- Cognexus reference project: `/Users/tony/git/cognexus` (proven Tauri+Blazor pattern)
- Tauri: https://tauri.app/
- Blazor: https://learn.microsoft.com/en-us/aspnet/core/blazor/
- Radzen: https://blazor.radzen.com/
