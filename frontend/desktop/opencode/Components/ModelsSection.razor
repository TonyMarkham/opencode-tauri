  @namespace OpenCode.Components
  @inject IConfigService ConfigService
  @inject ILogger<ModelsSection> Logger
  @using OpenCode.Services
  @implements IDisposable

  <RadzenFieldset Text="Models" Style="margin-bottom: 1rem;" aria-label="Model Configuration">
      <RadzenStack Gap="1rem">

          @* Default Model Dropdown *@
          <RadzenRow AlignItems="AlignItems.Center">
              <RadzenColumn Size="3">
                  <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                      Default Model
                  </RadzenText>
              </RadzenColumn>
              <RadzenColumn Size="9">
                  <RadzenDropDown
                      @bind-Value="_selectedDefaultModel"
                      Data="_curatedModels"
                      TextProperty="Name"
                      ValueProperty="FullId"
                      Placeholder="Select default model..."
                      Style="width: 100%;"
                      Disabled="_loading"
                      aria-label="Select default model" />
              </RadzenColumn>
          </RadzenRow>

          @* Curated Models List *@
          <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color); margin-top: 0.5rem;">
              Available Models (@(_curatedModels?.Count ?? 0))
          </RadzenText>

          @if (_loading && _curatedModels == null)
          {
              <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" aria-label="Loading models..." />
          }
          else
          {
              <RadzenDataGrid
                  Data="_curatedModels"
                  TItem="CuratedModel"
                  AllowSorting="true"
                  Style="height: 200px;"
                  Density="Density.Compact">
                  <Columns>
                      <RadzenDataGridColumn TItem="CuratedModel" Property="Name" Title="Name" Width="200px" />
                      <RadzenDataGridColumn TItem="CuratedModel" Property="Provider" Title="Provider" Width="120px">
                          <Template Context="model">
                              <RadzenBadge BadgeStyle="@GetProviderBadgeStyle(model.Provider)" Text="@model.Provider" />
                          </Template>
                      </RadzenDataGridColumn>
                      <RadzenDataGridColumn TItem="CuratedModel" Property="ModelId" Title="Model ID" />
                  </Columns>
              </RadzenDataGrid>
          }

          @* Stale data warning *@
          @if (ConfigService.State == ConfigLoadState.Stale)
          {
              <RadzenAlert
                  AlertStyle="AlertStyle.Warning"
                  Variant="Variant.Flat"
                  Shade="Shade.Lighter"
                  AllowClose="false"
                  role="alert">
                  Showing cached data. Refresh failed: @ConfigService.ErrorMessage
              </RadzenAlert>
          }

          @* Error display *@
          @if (ConfigService.State == ConfigLoadState.Error && _error != null)
          {
              <RadzenAlert
                  AlertStyle="AlertStyle.Danger"
                  Variant="Variant.Flat"
                  Shade="Shade.Lighter"
                  AllowClose="true"
                  Close="@DismissError"
                  role="alert"
                  aria-live="assertive">
                  @_error
              </RadzenAlert>
          }

          @* Action Buttons *@
          <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Style="margin-top: 0.5rem;" role="group" aria-label="Model actions">
              <RadzenButton
                  Text="Refresh"
                  Icon="refresh"
                  ButtonStyle="ButtonStyle.Light"
                  Click="RefreshAsync"
                  Disabled="_loading"
                  aria-label="Refresh models"
                  title="Refresh model list" />
          </RadzenStack>

          @if (_loading)
          {
              <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
          }

      </RadzenStack>
  </RadzenFieldset>

  @code {
      private List<CuratedModel>? _curatedModels;
      private string? _selectedDefaultModel;
      private bool _loading;
      private string? _error;

      protected override async Task OnInitializedAsync()
      {
          // Subscribe to config changes
          ConfigService.ConfigChanged += OnConfigChanged;

          // Load initial data
          await LoadDataAsync();
      }

      private async Task LoadDataAsync()
      {
          _loading = true;
          _error = null;

          try
          {
              var (_, modelsConfig) = await ConfigService.GetConfigAsync();

              if (modelsConfig != null)
              {
                  _curatedModels = modelsConfig.Models.Curated;
                  _selectedDefaultModel = modelsConfig.Models.DefaultModel;

                  Logger.LogDebug("Models loaded: {Count} curated, default={Default}",
                      _curatedModels.Count, _selectedDefaultModel);
              }
              else if (ConfigService.State == ConfigLoadState.Error)
              {
                  _error = ConfigService.ErrorMessage ?? "Failed to load models";
              }
          }
          catch (Exception ex)
          {
              _error = "Failed to load models";
              Logger.LogError(ex, "Error loading models");
          }
          finally
          {
              _loading = false;
          }
      }

      private async Task RefreshAsync()
      {
          _loading = true;
          _error = null;

          try
          {
              await ConfigService.RefreshAsync();

              // Update local state from service
              var modelsConfig = ConfigService.ModelsConfig;
              if (modelsConfig != null)
              {
                  _curatedModels = modelsConfig.Models.Curated;
                  _selectedDefaultModel = modelsConfig.Models.DefaultModel;
              }
          }
          catch (Exception ex)
          {
              _error = "Refresh failed";
              Logger.LogError(ex, "Error refreshing models");
          }
          finally
          {
              _loading = false;
          }
      }

      private void OnConfigChanged(object? sender, ConfigChangedEventArgs e)
      {
          // Config updated in background - refresh UI
          InvokeAsync(() =>
          {
              var modelsConfig = ConfigService.ModelsConfig;
              if (modelsConfig != null)
              {
                  _curatedModels = modelsConfig.Models.Curated;
                  _selectedDefaultModel = modelsConfig.Models.DefaultModel;
              }

              StateHasChanged();
          });
      }

      private void DismissError() => _error = null;

      private BadgeStyle GetProviderBadgeStyle(string provider) => provider.ToLower() switch
      {
          "openai" => BadgeStyle.Success,
          "anthropic" => BadgeStyle.Warning,
          "google" => BadgeStyle.Info,
          "openrouter" => BadgeStyle.Secondary,
          _ => BadgeStyle.Light
      };

      public void Dispose()
      {
          ConfigService.ConfigChanged -= OnConfigChanged;
      }

  }